 {{/*
layouts/shortcodes/carousel.html
Dynamic carousel that automatically finds images in a page bundle

USAGE:
1. **Page Bundle Approach (Recommended):**
   - Create a page bundle: content/my-page/my-page.md
   - Put images directly in: content/my-page/image1.jpg, content/my-page/image2.png, etc.
   - Use: {{< carousel >}}
   - Use: {{< carousel height="500px" interval="3000" >}}

2. **Page Bundle Subdirectory Approach:**
   - Create a page bundle: content/my-page/my-page.md
   - Put images in a subdirectory: content/my-page/images/image1.jpg, etc.
   - Use: {{< carousel path="images/" >}}
   - Path is relative to the page bundle directory

PARAMETERS:
- path: Optional. Subdirectory within the page bundle where images are stored.
- height: Optional. Default "400px". Height of carousel images.
- interval: Optional. Default "5000". Auto-advance interval in milliseconds.

EXAMPLES:
{{< carousel >}}                                    // Uses all images in page bundle
{{< carousel height="300px" >}}                     // Custom height
{{< carousel path="event-preview-image/" >}}        // Images from a subdirectory
{{< carousel path="slides/" height="500px" interval="8000" >}}     // All options
*/}}

{{ $path := .Get "path" }}
{{ $height := .Get "height" | default "400px" }}
{{ $interval := .Get "interval" | default "5000" }}

{{ $images := slice }}

{{/* Handle both path-specified and default page bundle approaches */}}
{{ if $path }}
  {{/* If path is specified, look for images in the specified subdirectory of the page bundle */}}
  {{ if .Page.Resources }}
    {{ $dir := $path }}
    {{ range .Page.Resources }}
      {{ if and (findRE "(?i)\\.(jpe?g|png|gif|webp)$" .Name) (hasPrefix .Name $dir) }}
        {{ $images = $images | append (dict "Name" .Name "RelPermalink" .RelPermalink) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ else }}
  {{/* Use page bundle resources - this is the recommended approach */}}
  {{ if .Page.Resources }}
    {{ range .Page.Resources }}
      {{ if (findRE "(?i)\\.(jpe?g|png|gif|webp)$" .Name) }}
        {{ $images = $images | append (dict "Name" .Name "RelPermalink" .RelPermalink) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $images }}
  {{/* Create unique carousel ID */}}
  {{ $carouselID := printf "carousel-%d" .Ordinal }}
  
  <div id="{{ $carouselID }}" class="carousel slide" style="margin-bottom: 20px; position: relative;">
    {{/* Indicators (Bootstrap 3 style) - positioned to overlay bottom of images */}}
    <ol class="carousel-indicators" style="bottom: 15px; opacity: 1; z-index: 15; position: absolute; left: 0; right: 0; margin: 0 auto; padding: 0; list-style: none; display: flex; justify-content: center; gap: 4px; width: fit-content;">
      {{ range $index, $image := $images }}
      <li data-slide-to="{{ $index }}" {{ if eq $index 0 }}class="active"{{ end }} style="width: 20px; height: 6px; border-radius: 3px; background-color: {{ if eq $index 0 }}rgba(255,255,255,0.5){{ else }}rgba(255,255,255,0.2){{ end }}; border: none; outline: none; cursor: pointer; transition: background-color 0.2s ease;"></li>
      {{ end }}
    </ol>
    
    {{/* Carousel inner content */}}
    <div class="carousel-inner" role="listbox" style="position: relative; overflow: hidden; height: {{ $height }}; border-radius: 4px;">
      {{ range $index, $image := $images }}
      <div class="item {{ if eq $index 0 }}active{{ end }}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block !important; z-index: {{ if eq $index 0 }}2{{ else }}1{{ end }};">
        <img src="{{ $image.RelPermalink }}" alt="Carousel Image {{ add $index 1 }}" style="width: 100%; height: 100%; object-fit: cover; transition: opacity 500ms ease-in-out; opacity: {{ if eq $index 0 }}1{{ else }}0{{ end }};">
      </div>
      {{ end }}
    </div>
    
    {{/* Controls - Simple white arrows with flexible click area */}}
    <a class="left carousel-control" href="javascript:void(0)" role="button" style="background: none !important; color: rgba(255,255,255,0.5) !important; text-decoration: none !important; z-index: 20; position: absolute; left: 0px; top: 0; bottom: 0; width: 33%; font-size: 40px; font-weight: 300; transition: color 0.3s ease; text-align: left; display: flex; align-items: center; justify-content: flex-start; padding-left: 15px; background-image: none !important; text-shadow: none !important; filter: none !important; opacity: 1 !important;" onmouseover="this.style.setProperty('color', 'rgba(255,255,255,1.0)', 'important')" onmouseout="this.style.setProperty('color', 'rgba(255,255,255,0.5)', 'important')">
      &#8249;
      <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="javascript:void(0)" role="button" style="background: none !important; color: rgba(255,255,255,0.5) !important; text-decoration: none !important; z-index: 20; position: absolute; right: 0px; top: 0; bottom: 0; width: 33%; font-size: 40px; font-weight: 300; transition: color 0.3s ease; text-align: right; display: flex; align-items: center; justify-content: flex-end; padding-right: 15px; background-image: none !important; text-shadow: none !important; filter: none !important; opacity: 1 !important;" onmouseover="this.style.setProperty('color', 'rgba(255,255,255,1.0)', 'important')" onmouseout="this.style.setProperty('color', 'rgba(255,255,255,0.5)', 'important')">
      &#8250;
      <span class="sr-only">Next</span>
    </a>
  </div>
  
  {{/* Simplified working JavaScript */}}
  <script>
  (function() {
    var carouselId = '{{ $carouselID }}';
    var currentSlide = 0;
    var totalSlides = {{ len $images }};
    var autoInterval = null;
    
    console.log('üé† Initializing carousel:', carouselId, 'with', totalSlides, 'slides');
    
    function showSlide(index) {
      var carousel = document.getElementById(carouselId);
      if (!carousel) {
        console.error('‚ùå Carousel not found:', carouselId);
        return;
      }
      
      var slides = carousel.querySelectorAll('.carousel-inner .item');
      var indicators = carousel.querySelectorAll('.carousel-indicators li');
      
      console.log('üëÄ Showing slide', index, 'of', slides.length);
      
      // Don't change anything if we're already on this slide
      if (currentSlide === index) {
        return;
      }
      
      // Simply fade out all slides and fade in the target slide
      for (var i = 0; i < slides.length; i++) {
        var img = slides[i].querySelector('img');
        if (i === index) {
          slides[i].style.zIndex = '2';
          slides[i].style.display = 'block';  // Ensure slide is visible
          slides[i].classList.add('active');
          img.style.opacity = '1';
        } else {
          slides[i].style.zIndex = '1';
          slides[i].style.display = 'block';  // Keep all slides visible for stacking
          slides[i].classList.remove('active');
          img.style.opacity = '0';
        }
      }
      
      // Update indicators
      for (var i = 0; i < indicators.length; i++) {
        indicators[i].classList.remove('active');
        indicators[i].style.backgroundColor = 'rgba(255,255,255,0.5)';
      }
      if (indicators[index]) {
        indicators[index].classList.add('active');
        indicators[index].style.backgroundColor = 'rgba(255,255,255,1)';
      }
      
      currentSlide = index;
      console.log('‚úÖ Slide', index, 'is now active with image crossfade');
    }
    
    function nextSlide() {
      console.log('‚û°Ô∏è Next slide');
      var next = (currentSlide + 1) % totalSlides;
      showSlide(next);
      // Don't reset auto-advance here to avoid conflicts with hover events
    }
    
    function prevSlide() {
      console.log('‚¨ÖÔ∏è Previous slide');  
      var prev = (currentSlide - 1 + totalSlides) % totalSlides;
      showSlide(prev);
      // Don't reset auto-advance here to avoid conflicts with hover events
    }
    
    function goToSlide(index) {
      console.log('üéØ Go to slide', index);
      showSlide(index);
      // Don't reset auto-advance here to avoid conflicts with hover events
    }
    
    function startAutoAdvance() {
      // Always clear any existing interval first
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
      }
      
      console.log('‚è∞ Starting auto-advance');
      autoInterval = setInterval(function() {
        console.log('üîÑ Auto-advancing...');
        var next = (currentSlide + 1) % totalSlides;
        showSlide(next);
      }, {{ $interval }});
    }
    
    function stopAutoAdvance() {
      if (autoInterval) {
        console.log('‚è∏Ô∏è Stopping auto-advance');
        clearInterval(autoInterval);
        autoInterval = null;
      }
    }
    
    function resetAutoAdvance() {
      stopAutoAdvance();
      startAutoAdvance();
    }
    
    function init() {
      var carousel = document.getElementById(carouselId);
      if (!carousel) {
        console.error('‚ùå Carousel element not found');
        return;
      }
      
      console.log('üîß Setting up event listeners...');
      
      // Navigation buttons
      var prevBtn = carousel.querySelector('.left.carousel-control');
      var nextBtn = carousel.querySelector('.right.carousel-control');
      var indicators = carousel.querySelectorAll('.carousel-indicators li');
      
      if (prevBtn) {
        prevBtn.onclick = function(e) {
          e.preventDefault();
          prevSlide();
          return false;
        };
      }
      
      if (nextBtn) {
        nextBtn.onclick = function(e) {
          e.preventDefault();
          nextSlide();
          return false;
        };
      }
      
      // Indicator buttons
      for (var i = 0; i < indicators.length; i++) {
        (function(idx) {
          indicators[idx].onclick = function(e) {
            e.preventDefault();
            goToSlide(idx);
            return false;
          };
        })(i);
      }
      
      // Hover pause/resume
      carousel.onmouseenter = stopAutoAdvance;
      carousel.onmouseleave = startAutoAdvance;
      
      // Initialize
      showSlide(0);
      startAutoAdvance();
      
      console.log('‚úÖ Carousel initialized successfully!');
    }
    
    // Start when ready
    if (document.readyState === 'complete') {
      init();
    } else {
      document.addEventListener('DOMContentLoaded', init);
      window.addEventListener('load', init); // Fallback
    }
    
  })();
  </script>
  
{{ else }}
  <div class="alert alert-info">
    <p><strong>No images found for carousel.</strong></p>
    <p>To use this carousel:</p>
    <ul>
      <li><strong>Page Bundle approach:</strong> Put images directly in the same folder as your .md file</li>
      <li><strong>Subdirectory approach:</strong> Specify path parameter like <code>{{ printf "{{< carousel path=\"event-preview-image/\" >}}" }}</code></li>
    </ul>
  </div>
{{ end }}
